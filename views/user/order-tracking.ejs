<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yadro - Order Tracking</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/ScrollTrigger.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'yadro-red': '#FF3366',
            'yadro-dark-red': '#CC1A4A',
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

    body {
      font-family: 'Poppins', sans-serif;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #FF3366 0%, #FF6B6B 100%);
    }

    .card-hover {
      transition: all 0.3s ease;
    }

    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(255, 51, 102, 0.1);
    }

    .progress-bar {
      position: relative;
      overflow: hidden;
    }

    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, #FF3366 0%, #FF6B6B 100%);
      animation: shimmer 2s infinite linear;
    }

    @keyframes shimmer {
      0% {
        transform: translateX(-100%);
      }

      100% {
        transform: translateX(100%);
      }
    }

    .animate-float {
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    /* New styles for breadcrumbs */
    .breadcrumb-item {
      position: relative;
      padding-right: 24px;
    }

    .breadcrumb-item:not(:last-child)::after {
      content: '';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 6px;
      height: 6px;
      border-top: 2px solid #CBD5E0;
      border-right: 2px solid #CBD5E0;
      transform: translateY(-50%) rotate(45deg);
    }

    .cancel-button {
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .cancel-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: 0.5s;
    }

    .cancel-button:hover::before {
      left: 100%;
    }

    .address-card {
      transition: all 0.3s ease;
      border-left: 4px solid #FF3366;
    }

    .address-card:hover {
      transform: translateX(5px);
    }
  </style>
</head>

<body class="bg-gray-50 font-sans">
  <%- include('../layouts/header-with-user.ejs') %>

  <nav aria-label="Breadcrumb" class="container mx-auto px-4 py-4">
    <ol class="flex items-center space-x-1 text-sm">
      <% breadcrumbs.forEach((crumb, index) => { %>
      <li class="breadcrumb-item">
        <% if (crumb.url) { %>
        <a href="<%= crumb.url %>" class="text-gray-500 hover:text-red-500 transition duration-300">
          <% if (crumb.icon) { %>
          <i class="<%= crumb.icon %> mr-1"></i>
          <% } %>
          <%= crumb.text %>
        </a>
        <% } else { %>
        <span class="text-gray-900 font-medium"><%= crumb.text %></span>
        <% } %>
      </li>
      <% }) %>
    </ol>
  </nav>


  <main class="container mx-auto px-4 py-12">
    <h1 class="text-4xl font-bold mb-8 text-yadro-red text-center">Your Order Journey</h1>

    <div class="bg-white rounded-xl shadow-2xl p-8 mb-12 gradient-bg text-white">
      <h2 class="text-3xl font-semibold mb-6">Status: <span class="text-white animate-pulse"><%= order.orderStatus %></span></h2>

      <div class="relative">
        <div class="flex justify-between mb-4">
          <div class="w-1/4 text-center">
            <div class="w-16 h-16 mx-auto bg-white rounded-full text-lg text-yadro-red flex items-center justify-center shadow-lg animate-float">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
              </svg>
            </div>
            <div class="mt-2 font-medium">Ordered</div>
          </div>
          <div class="w-1/4 text-center">
            <div class="w-16 h-16 mx-auto bg-white rounded-full text-lg text-yadro-red flex items-center justify-center shadow-lg animate-float" style="animation-delay: 0.5s;">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
              </svg>
            </div>
            <div class="mt-2 font-medium">Shipped</div>
          </div>
          <div class="w-1/4 text-center">
            <div class="w-16 h-16 mx-auto bg-white rounded-full text-lg text-yadro-red flex items-center justify-center shadow-lg animate-float" style="animation-delay: 1s;">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"></path>
              </svg>
            </div>
            <div class="mt-2 font-medium">Out for delivery</div>
          </div>
          <div class="w-1/4 text-center">
            <div class="w-16 h-16 mx-auto bg-white rounded-full text-lg text-yadro-red flex items-center justify-center shadow-lg animate-float" style="animation-delay: 1.5s;">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            </div>
            <div class="mt-2 font-medium">Delivered</div>
          </div>
        </div>
        <div class="h-2 bg-white bg-opacity-30 rounded-full mt-4 overflow-hidden progress-bar">
          <div class="w-full h-full bg-white rounded-full" style="width: <%= order.statusProgress %>%;"></div>
        </div>
      </div>
    </div>

    <!-- Add Cancel Order Button after the status progress bar -->
    <div class="text-start my-6">
      <% if (order.orderStatus === 'Ordered' || order.orderStatus === 'Shipping') { %>
      <a href="/orders/cancel/<%= order._id %>" class="cancel-button bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-8 rounded-full shadow-lg transform transition hover:scale-105">
        Cancel Order
      </a>
      <% } %>
    </div>

    <div class="bg-white rounded-xl shadow-xl p-8">
      <h3 class="text-2xl font-semibold mb-6 text-yadro-red">Order Details</h3>
      <div class="space-y-4">
        <% if (order.items && order.items.length > 0) { %>
        <% order.items.forEach((item, index) => { %>
        <div class="bg-white p-4 shadow rounded">
          <h3 class="font-bold text-lg mb-2">Product <%= index + 1 %></h3>
          <% if (item && item.productId) { %>
          <div class="flex items-start">
            <img src="<%= item.productId.images && item.productId.images.length > 0 ? item.productId.images[0] : '/api/placeholder/100/100' %>" alt="<%= item.productId.productName || 'Product Image' %>" class="w-24 h-24 object-cover mr-4">
            <div>
              <h4 class="font-semibold"><%= item.productId.productName || 'Product Name Not Available' %></h4>
              <p class="text-sm">Quantity: <%= item.quantity %></p>
              <p class="text-sm">Price: ₹ <%= item.price ? item.price.toFixed(2) : 'N/A' %></p>
              <p class="text-sm text-gray-600 mt-1"><%= item.productId.description || 'No description available' %></p>
            </div>
          </div>
          <% } else { %>
          <p class="text-red-500">Invalid item data</p>
          <% } %>
        </div>
        <% }); %>
        <% } else { %>
        <p class="text-center text-red-500">No items found in this order</p>
        <% } %>
      </div>


      <div class="mt-8 border-t border-red-100 pt-6">
        <div class="flex justify-between items-center mb-4">
          <span class="text-gray-600 text-lg">Subtotal:</span>
          <span class="font-semibold text-xl text-yadro-red">₹ <%= Math.round(order.totalAmount) %></span>
        </div>
        <div class="flex justify-between items-center mb-4">
          <span class="text-gray-600 text-lg">Coupon Discount:</span>
          <% if(order.couponApplied !== null) { %>
          <span class="font-semibold text-xl text-yadro-red">₹ -<%= Math.round(order.offerApplied) %></span>
          <% } else { %>
          <span class="font-semibold text-xl text-yadro-red">No Offer Applied</span>
          <% } %>
        </div>
        <div class="flex justify-between items-center mb-4">
          <span class="text-gray-600 text-lg">Shipping:</span>
          <span class="font-semibold text-xl text-yadro-red">Free</span>
        </div>
        <div class="flex justify-between items-center text-2xl font-bold">
          <span class="text-gray-800">Total:</span>
          <% if(order.couponApplied !== null) { %>
          <span class="text-green-500">₹ <%= Math.round((order.totalAmount - order.offerApplied)) %></span>
          <% } else { %>
          <span class="text-green-500">₹ <%= Math.round(order.totalAmount) %></span>
          <% } %>
        </div>
      </div>



      <!-- Add order information section -->
      <div class="mt-8 border-t border-red-100 pt-6">
        <h3 class="text-xl font-semibold mb-4 text-yadro-red">Order Information</h3>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <p class="text-gray-600">Order ID:</p>
            <p class="font-medium"><%= order._id %></p>
          </div>
          <div>
            <p class="text-gray-600">Order Date:</p>
            <p class="font-medium"><%= order.formattedDate %></p>
          </div>
          <div>
            <p class="text-gray-600">Payment Method:</p>
            <p class="font-medium"><%= order.paymentMethod %></p>
          </div>
          <div>
            <p class="text-gray-600">Order Status:</p>
            <p class="font-medium"><%= order.orderStatus %></p>
          </div>
          <% if (order.cancellationReason) { %>
          <div>
            <p class="text-gray-600">Cancellation :</p>
            <p class="font-medium "><span class="text-red-500">Reason : </span><%= order.cancellationReason%></p>
            <% if (order.cancellationComment) { %>
            <p class="font-medium"><span class="text-red-500">Comments :</span> <%= order.cancellationComment%></p>

            <% } %>
            <p class="font-medium "><span class="text-red-500">Time : </span><%= order.cancelDate %></p>
          </div>
          <% } %>
        </div>
      </div>

      <!-- Add Shipping Address Section before Order Details -->
      <div class="bg-white rounded-xl shadow-xl p-8 mb-8">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-semibold text-yadro-red">Shipping Address</h3>
          <div class="px-4 py-2 bg-green-100 text-green-800 rounded-full text-sm font-medium">
            <%= order.orderStatus %>
          </div>
        </div>

        <div class="address-card bg-gray-50 p-6 rounded-lg">
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <i class="fas fa-map-marker-alt text-yadro-red text-2xl"></i>
            </div>
            <div class="ml-4">
              <% if (order.deliveryAddress) { %>
              <h4 class="font-semibold text-lg mb-2"><%= order.deliveryAddress.name %></h4>
              <p class="text-gray-600 leading-relaxed">
                <%= order.deliveryAddress.streetAddress %><br>
                <%= order.deliveryAddress.city %>, <%= order.deliveryAddress.state %><br>
                <%= order.deliveryAddress.postalCode %><br>
                Phone: <%= order.deliveryAddress.phone %>
              </p>
              <% } else { %>
              <p class="text-red-500">Delivery address not available</p>
              <% } %>

              <div class="mt-3 text-sm text-gray-500">
                <% if (order.userId) { %>
                <p>Order By: <%= order.userId.fname %> <%= order.userId.lname %></p>
                <p>Email: <%= order.userId.email %></p>
                <% } %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <%- include('../layouts/footer.ejs') %>

  <script>
    // Animate breadcrumbs
    const breadcrumbItems = document.querySelectorAll('.breadcrumb-item');
    gsap.from(breadcrumbItems, {
      opacity: 0,
      x: -20,
      stagger: 0.1,
      duration: 0.5,
      ease: 'power2.out'
    });


    gsap.registerPlugin(ScrollTrigger);

    // Animate the progress bar
    gsap.from(".progress-bar .bg-white", {
      width: 0,
      duration: 2,
      ease: "power2.out",
      scrollTrigger: {
        trigger: ".progress-bar",
        start: "top 80%",
        end: "bottom 20%",
        toggleActions: "restart pause resume pause"
      }
    });

    // Animate the status icons
    gsap.from(".w-16", {
      scale: 0,
      opacity: 0,
      duration: 0.8,
      stagger: 0.2,
      ease: "back.out(1.7)",
      scrollTrigger: {
        trigger: ".gradient-bg",
        start: "top 80%",
        end: "bottom 20%",
        toggleActions: "restart pause resume pause"
      }
    });

    // Animate the order details
    gsap.from(".card-hover", {
      y: 50,
      opacity: 0,
      duration: 1,
      stagger: 0.3,
      ease: "power3.out",
      scrollTrigger: {
        trigger: ".space-y-6",
        start: "top 80%",
        end: "bottom 20%",
        toggleActions: "restart pause resume pause"
      }
    });


    gsap.from(".address-card", {
      x: -50,
      opacity: 0,
      duration: 1,
      ease: "power3.out",
      scrollTrigger: {
        trigger: ".address-card",
        start: "top 80%",
        toggleActions: "restart pause resume pause"
      }
    });

    gsap.from(".cancel-button", {
      scale: 0.8,
      opacity: 0,
      duration: 0.5,
      ease: "back.out(1.7)",
      scrollTrigger: {
        trigger: ".cancel-button",
        start: "top 90%",
        toggleActions: "restart pause resume pause"
      }
    });

    // Cancel order confirmation
    function confirmCancel() {
      if (confirm('Are you sure you want to cancel this order?')) {
        // Show loading state
        const button = document.querySelector('.cancel-button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        button.disabled = true;

        // Make API call to cancel order
        fetch('/api/orders/<%= order._id %>/cancel', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Show success message and reload page
              alert('Order cancelled successfully');
              window.location.reload();
            } else {
              throw new Error(data.message || 'Failed to cancel order');
            }
          })
          .catch(error => {
            alert(error.message);
            // Reset button state
            button.innerHTML = originalText;
            button.disabled = false;
          });
      }
    }
  </script>
</body>

</html>